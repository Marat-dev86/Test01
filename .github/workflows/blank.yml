name: Windows 10 Tailscale Setup (VNC)

on:
  workflow_dispatch:
    inputs:
      username:
        description: "Enter the username for the remote user"
        required: true
        default: "runneradmin"
      password:
        description: "Enter the password for the remote user"
        required: true
        default: "@cyb3rking"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Download and Install Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet" -Wait

    - name: Authenticate Tailscale (Manual Step)
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up

    - name: Verify Tailscale Connection
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" status

    - name: Create or Update User for VNC Access
      run: |
        $username = "${{ github.event.inputs.username }}"
        $password = "${{ github.event.inputs.password }}"
        
        $user = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        if ($null -eq $user) {
            New-LocalUser -Name $username -Password (ConvertTo-SecureString -AsPlainText $password -Force) -FullName $username -Description "VNC user"
        } else {
            Set-LocalUser -Name $username -Password (ConvertTo-SecureString -AsPlainText $password -Force)
        }
        Add-LocalGroupMember -Group "Administrators" -Member $username

    - name: Download and Install VirtualBox
      run: |
        Invoke-WebRequest https://download.virtualbox.org/virtualbox/7.0.14/VirtualBox-7.0.14-161095-Win.exe -OutFile virtualbox.exe
        Start-Process -FilePath "virtualbox.exe" -ArgumentList "/S" -Wait

    - name: Download and Install TigerVNC
      run: |
        Invoke-WebRequest https://sourceforge.net/projects/tigervnc/files/stable/1.12.0/tigervnc64-1.12.0.exe/download -OutFile tigervnc.exe
        Start-Process -FilePath "tigervnc.exe" -ArgumentList "/silent" -Wait

    - name: Configure and Start VNC Server
      run: |
        $vncPass = ConvertTo-SecureString "${{ github.event.inputs.password }}" -AsPlainText -Force
        New-Item -ItemType Directory -Path "C:\Users\${{ github.event.inputs.username }}\.vnc" -Force
        $vncPass | Out-File -Encoding ASCII "C:\Users\${{ github.event.inputs.username }}\.vnc\passwd"
        Start-Process -FilePath "C:\Program Files\TigerVNC\vncserver.exe" -ArgumentList ":1 -rfbport 5901 -localhost no" -NoNewWindow -PassThru

    - name: Keep System Running
      run: |
        while ($true) { Start-Sleep -Seconds 10 }
