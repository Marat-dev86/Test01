name: Windows RDP - Pinggy Tunnel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
      # Step 1: Enable Remote Desktop
      - name: Enable Remote Desktop
        run: |
          echo "Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          echo "✅ Remote Desktop Enabled."

      # Step 2: Install OpenSSH (for Tunnel)
      - name: Install OpenSSH
        run: |
          echo "Installing OpenSSH..."
          Add-WindowsFeature -Name OpenSSH-Server
          Start-Service sshd
          Set-Service -Name sshd -StartupType Automatic
          echo "✅ OpenSSH installed and running."

      # Step 3: Download & Configure Pinggy
      - name: Download & Configure Pinggy
        run: |
          echo "Downloading Pinggy..."
          Invoke-WebRequest -Uri "https://github.com/pinggy-io/pinggy/releases/latest/download/pinggy.exe" -OutFile pinggy.exe
          echo "✅ Pinggy downloaded."

      # Step 4: Start Pinggy SSH Tunnel
      - name: Start Pinggy Tunnel
        run: |
          echo "Starting Pinggy SSH tunnel..."
          Start-Process -NoNewWindow -FilePath "pinggy.exe" -ArgumentList "-p 443 -R0:127.0.0.1:3389 -L4300:127.0.0.1:4300 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 M8VegescUgm@a.pinggy.io"
          echo "✅ Pinggy tunnel started."

      # Step 5: Keep Workflow Running
      - name: Keep Workflow Running
        run: |
          echo "Workflow is running indefinitely..."
          while ($true) { Start-Sleep -Seconds 60 }
